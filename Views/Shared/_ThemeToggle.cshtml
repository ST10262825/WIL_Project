@using TutorConnect.WebApp.Services
@inject ApiService ApiService

<button onclick="toggleTheme()" class="btn theme-toggle" title="Toggle theme" id="themeToggleButton">
    <i id="themeIcon" class="fas fa-moon"></i>
    <span id="themeText" class="theme-text">Dark Mode</span>
</button>

<script>
    // Enhanced toggle function with better error handling
    async function toggleTheme() {
        console.log('=== THEME TOGGLE START ===');

        try {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';

            console.log('1. Current theme:', currentTheme);
            console.log('2. New theme:', newTheme);

            // Update UI immediately
            console.log('3. Updating localStorage and UI...');
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
            updateThemeButton(newTheme);

            // Save to server via WebApp controller
            console.log('4. Saving to server via WebApp controller...');
            await saveThemeViaWebApp(newTheme);

            console.log('=== THEME TOGGLE COMPLETE ===');

        } catch (error) {
            console.error('❌ THEME TOGGLE ERROR:', error);
        }
    }

    // Save theme via WebApp controller - FIXED VERSION
    async function saveThemeViaWebApp(theme) {
        try {
            // Get anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;
            console.log('Anti-forgery token found:', !!token);

            const response = await fetch('/Theme/UpdateTheme', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token || '',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ theme: theme })
            });

            console.log('Response status:', response.status);
            console.log('Response OK:', response.ok);

            if (response.ok) {
                const result = await response.json();
                console.log('✅ Theme saved via WebApp:', result);
            } else {
                // Try to get error details
                const errorText = await response.text();
                console.log('❌ Server returned error:', response.status, errorText);
                console.log('⚠️ Theme saved locally only (server update failed)');
            }
        } catch (error) {
            console.log('⚠️ Theme saved locally only (network error):', error);
        }
    }

    // Initialize button on page load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== THEME TOGGLE INITIALIZATION ===');
        const currentTheme = localStorage.getItem('theme') || 'light';
        console.log('Initial theme from localStorage:', currentTheme);
        updateThemeButton(currentTheme);
    });
</script>

<style>
    .theme-toggle {
        border: 1px solid var(--border-color);
        background-color: var(--bg-secondary);
        color: var(--text-primary);
        transition: all 0.3s ease;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-right: 10px;
    }

        .theme-toggle:hover {
            background-color: var(--bg-tertiary);
            transform: translateY(-1px);
        }

        .theme-toggle .theme-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

    /* Responsive design */
    @@media (max-width: 768px) {
        .theme-toggle .theme-text

    {
        display: none;
    }

    .theme-toggle {
        padding: 0.5rem;
        border-radius: 50%;
        width: 2.5rem;
        height: 2.5rem;
        justify-content: center;
    }

    }
</style>