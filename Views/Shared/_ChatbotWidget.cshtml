<div id="chatbotWidget" class="chatbot-widget">
    <!-- Chatbot toggle button -->
    <button id="chatbotToggle" class="chatbot-toggle btn btn-primary rounded-circle">
        <i class="fas fa-robot"></i>
    </button>

    <!-- Chatbot container -->
    <div id="chatbotContainer" class="chatbot-container" style="display: none;">
        <div class="chatbot-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-0">
                        <i class="fas fa-robot me-2"></i>TutorBot Assistant
                    </h6>
                    <small class="text-muted">Online</small>
                </div>
                <div>
                    <button id="chatbotMinimize" class="btn btn-sm btn-outline-secondary me-2">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button id="chatbotClose" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="chatbot-messages" id="chatbotMessages">
            <!-- Messages will be loaded here -->
            <div class="welcome-message">
                <div class="message bot-message">
                    <div class="message-content">
                        <strong>Hi there! 👋</strong><br>
                        I'm TutorBot, your TutorConnect assistant. I can help you with:
                        <ul>
                            <li>Booking sessions</li>
                            <li>Finding tutors</li>
                            <li>Account questions</li>
                            <li>Technical issues</li>
                        </ul>
                        What can I help you with today?
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>
        </div>

        <div class="chatbot-suggestions" id="chatbotSuggestions">
            <!-- Quick suggestions will appear here -->
        </div>

        <div class="chatbot-input">
            <div class="input-group">
                <input type="text"
                       id="chatbotInput"
                       class="form-control"
                       placeholder="Ask me anything about TutorConnect..."
                       maxlength="500">
                <button id="chatbotSend" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <small class="text-muted mt-1 d-block">
                TutorBot may make mistakes. Always verify important information.
            </small>
        </div>
    </div>
</div>

<style>
    .chatbot-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }

    .chatbot-toggle {
        width: 60px;
        height: 60px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        position: relative;
    }

        .chatbot-toggle::after {
            content: '';
            position: absolute;
            top: -5px;
            right: -5px;
            width: 12px;
            height: 12px;
            background: #28a745;
            border-radius: 50%;
            border: 2px solid white;
        }

    .chatbot-container {
        width: 380px;
        height: 600px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        display: flex;
        flex-direction: column;
        border: 1px solid #e0e0e0;
    }

    .chatbot-header {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
    }

    .chatbot-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background: #f8f9fa;
    }

    .chatbot-suggestions {
        padding: 10px 15px;
        border-top: 1px solid #e0e0e0;
        background: white;
    }

    .chatbot-input {
        padding: 15px;
        border-top: 1px solid #e0e0e0;
        background: white;
        border-radius: 0 0 12px 12px;
    }

    .message {
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
    }

    .user-message {
        align-items: flex-end;
    }

    .bot-message {
        align-items: flex-start;
    }

    .message-content {
        padding: 12px 16px;
        border-radius: 18px;
        max-width: 85%;
        word-wrap: break-word;
    }

    .user-message .message-content {
        background: #007bff;
        color: white;
        border-bottom-right-radius: 4px;
    }

    .bot-message .message-content {
        background: white;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 4px;
    }

    .message-time {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 4px;
    }

    .suggestion-chip {
        display: inline-block;
        background: #e9ecef;
        border: 1px solid #dee2e6;
        border-radius: 20px;
        padding: 6px 12px;
        margin: 2px 4px 2px 0;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
    }

        .suggestion-chip:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

    .typing-indicator {
        display: inline-flex;
        align-items: center;
        color: #6c757d;
        font-style: italic;
    }

    .typing-dots {
        display: inline-flex;
        margin-left: 4px;
    }

        .typing-dots span {
            animation: typing 1.4s infinite;
            margin: 0 1px;
        }

            .typing-dots span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .typing-dots span:nth-child(3) {
                animation-delay: 0.4s;
            }

    @@keyframes typing {
        0%, 60%, 100% {
            opacity: 0.3;
        }

        30% {
            opacity: 1;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatbot = {
            currentConversationId: null,
            isOpen: false,

            init() {
                this.bindEvents();
                this.loadConversationHistory();
            },

            bindEvents() {
                // Toggle chatbot
                document.getElementById('chatbotToggle').addEventListener('click', () => this.toggle());
                document.getElementById('chatbotClose').addEventListener('click', () => this.close());
                document.getElementById('chatbotMinimize').addEventListener('click', () => this.minimize());

                // Send message
                document.getElementById('chatbotSend').addEventListener('click', () => this.sendMessage());
                document.getElementById('chatbotInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            },

            toggle() {
                const container = document.getElementById('chatbotContainer');
                this.isOpen = !this.isOpen;
                container.style.display = this.isOpen ? 'flex' : 'none';
            },

            close() {
                this.isOpen = false;
                document.getElementById('chatbotContainer').style.display = 'none';
            },

            minimize() {
                this.isOpen = false;
                document.getElementById('chatbotContainer').style.display = 'none';
            },

            async sendMessage() {
                const input = document.getElementById('chatbotInput');
                const message = input.value.trim();

                if (!message) return;

                // Add user message to UI
                this.addMessage(message, true);
                input.value = '';

                // Show typing indicator
                this.showTypingIndicator();

                try {
                    // Call WebApp endpoint that uses ApiService
                    const response = await fetch('/Chatbot/SendMessage', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': this.getAntiForgeryToken()
                        },
                        body: JSON.stringify({
                            question: message,
                            conversationId: this.currentConversationId,
                            context: window.location.pathname
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.currentConversationId = data.conversationId;

                        this.removeTypingIndicator();
                        this.addMessage(data.answer, false);
                        this.showSuggestions(data.suggestions || []);
                        this.scrollToBottom();
                    } else {
                        const errorText = await response.text();
                        throw new Error(`API returned ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Chatbot API error:', error);
                    this.removeTypingIndicator();
                    this.addMessage('Sorry, I encountered a connection error. Please check your connection and try again.', false);
                }
            },

            getAntiForgeryToken() {
                const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
                return tokenInput ? tokenInput.value : '';
            },

            addMessage(content, isUser) {
                const messagesContainer = document.getElementById('chatbotMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

                const now = new Date();
                const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                messageDiv.innerHTML = `
                    <div class="message-content">
                        ${this.formatMessage(content)}
                    </div>
                    <div class="message-time">${timeString}</div>
                `;

                messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            },

            formatMessage(content) {
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
            },

            showTypingIndicator() {
                const messagesContainer = document.getElementById('chatbotMessages');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot-message';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="message-content">
                        <div class="typing-indicator">
                            TutorBot is typing
                            <div class="typing-dots">
                                <span>.</span><span>.</span><span>.</span>
                            </div>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                this.scrollToBottom();
            },

            removeTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
            },

            showSuggestions(suggestions) {
                const suggestionsContainer = document.getElementById('chatbotSuggestions');
                suggestionsContainer.innerHTML = '';

                if (suggestions && suggestions.length > 0) {
                    suggestions.forEach(suggestion => {
                        const chip = document.createElement('span');
                        chip.className = 'suggestion-chip';
                        chip.textContent = suggestion.text || suggestion;
                        chip.addEventListener('click', () => {
                            document.getElementById('chatbotInput').value = suggestion.text || suggestion;
                            this.sendMessage();
                        });
                        suggestionsContainer.appendChild(chip);
                    });
                }
            },

            scrollToBottom() {
                const messagesContainer = document.getElementById('chatbotMessages');
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            },

            async loadConversationHistory() {
                try {
                    const response = await fetch('/Chatbot/GetConversations');
                    if (response.ok) {
                        const conversations = await response.json();
                        if (conversations && conversations.length > 0) {
                            this.currentConversationId = conversations[0].conversationId;
                        }
                    }
                } catch (error) {
                    console.error('Error loading conversation history:', error);
                }
            }
        };

        chatbot.init();
    });
</script>
